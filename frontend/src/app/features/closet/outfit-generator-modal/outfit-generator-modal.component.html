<div class="organic-outfit-container" role="dialog" aria-labelledby="outfit-title" aria-describedby="outfit-description">

  <!-- Background Texture -->
  <div class="texture-overlay" aria-hidden="true"></div>

  <!-- Floating Close Button -->
  <button
    class="floating-close-btn"
    mat-dialog-close
    aria-label="Close outfit generator"
    type="button">
    <mat-icon aria-hidden="true">close</mat-icon>
  </button>

  <!-- Modal Content -->
  <div class="organic-modal-content">
    
    <!-- Loading State -->
    <div *ngIf="isLoading" class="organic-loading" role="status" aria-live="polite">
      <div class="loading-content">
        <mat-spinner diameter="50" aria-label="Loading"></mat-spinner>
        <p>Loading your closet...</p>
      </div>
    </div>

    <!-- Main Outfit Display -->
    <div *ngIf="!isLoading" class="organic-outfit-display">

      <!-- Floating Left Actions -->
      <aside class="floating-left-actions" aria-label="Quick actions">
        <button
          class="organic-action-btn shuffle-btn"
          (click)="handleRandomizeOutfit()"
          aria-label="Generate random outfit"
          type="button">
          <mat-icon aria-hidden="true">shuffle</mat-icon>
        </button>

        <button
          class="organic-action-btn clear-btn"
          (click)="handleClearOutfit()"
          aria-label="Clear all clothing items"
          type="button">
          <mat-icon aria-hidden="true">clear_all</mat-icon>
        </button>
      </aside>
      
      <!-- Central Mannequin Area -->
      <main class="organic-mannequin" #mannequinRef role="region" aria-label="Character outfit display">
        <!-- Silhouette Guide -->
        <div class="organic-silhouette" aria-hidden="true">
          <div class="body-guide">
            <div class="head-guide"></div>
            <div class="torso-guide"></div>
            <div class="legs-guide"></div>
            <div class="feet-guide"></div>
          </div>
        </div>
        
        <!-- Hat Layer -->
        <div
          class="organic-outfit-item hat-layer"
          *ngIf="getLayer('hat') && getCurrentItem(getLayer('hat')!) as hatItem"
          cdkDrag
          cdkDragBoundary=".organic-mannequin"
          (cdkDragStarted)="handleDragStarted()"
          (cdkDragEnded)="handleDragEnded()"
          (cdkDragDropped)="handleDragDropped($event)"
          role="img"
          [attr.aria-label]="'Hat: ' + (hatItem.originalFileName || 'Unnamed')">
          <img
            [src]="hatItem.thumbnailUrl || hatItem.imageUrl"
            [alt]="'Hat: ' + (hatItem.originalFileName || 'Unnamed hat')"
            class="outfit-item-image"
            loading="lazy">
          <div class="organic-drag-handle" aria-hidden="true">
            <mat-icon>drag_indicator</mat-icon>
          </div>
        </div>
        
        <!-- Top Layer -->
        <div
          class="organic-outfit-item top-layer"
          *ngIf="getLayer('top') && getCurrentItem(getLayer('top')!) as topItem"
          cdkDrag
          cdkDragBoundary=".organic-mannequin"
          (cdkDragStarted)="handleDragStarted()"
          (cdkDragEnded)="handleDragEnded()"
          (cdkDragDropped)="handleDragDropped($event)"
          role="img"
          [attr.aria-label]="'Top: ' + (topItem.originalFileName || 'Unnamed')">
          <img
            [src]="topItem.thumbnailUrl || topItem.imageUrl"
            [alt]="'Top: ' + (topItem.originalFileName || 'Unnamed top')"
            class="outfit-item-image"
            loading="lazy">
          <div class="organic-drag-handle" aria-hidden="true">
            <mat-icon>drag_indicator</mat-icon>
          </div>
        </div>

        <!-- Jacket Layer -->
        <div
          class="organic-outfit-item jacket-layer"
          *ngIf="getLayer('jacket') && getCurrentItem(getLayer('jacket')!) as jacketItem"
          cdkDrag
          cdkDragBoundary=".organic-mannequin"
          (cdkDragStarted)="handleDragStarted()"
          (cdkDragEnded)="handleDragEnded()"
          (cdkDragDropped)="handleDragDropped($event)"
          role="img"
          [attr.aria-label]="'Jacket: ' + (jacketItem.originalFileName || 'Unnamed')">
          <img
            [src]="jacketItem.thumbnailUrl || jacketItem.imageUrl"
            [alt]="'Jacket: ' + (jacketItem.originalFileName || 'Unnamed jacket')"
            class="outfit-item-image"
            loading="lazy">
          <div class="organic-drag-handle" aria-hidden="true">
            <mat-icon>drag_indicator</mat-icon>
          </div>
        </div>

        <!-- Bottom Layer -->
        <div
          class="organic-outfit-item jeans-layer"
          *ngIf="getLayer('jeans') && getCurrentItem(getLayer('jeans')!) as jeansItem"
          cdkDrag
          cdkDragBoundary=".organic-mannequin"
          (cdkDragStarted)="handleDragStarted()"
          (cdkDragEnded)="handleDragEnded()"
          (cdkDragDropped)="handleDragDropped($event)"
          role="img"
          [attr.aria-label]="'Bottom: ' + (jeansItem.originalFileName || 'Unnamed')">
          <img
            [src]="jeansItem.thumbnailUrl || jeansItem.imageUrl"
            [alt]="'Bottom: ' + (jeansItem.originalFileName || 'Unnamed bottom')"
            class="outfit-item-image"
            loading="lazy">
          <div class="organic-drag-handle" aria-hidden="true">
            <mat-icon>drag_indicator</mat-icon>
          </div>
        </div>

        <!-- Shoes Layer -->
        <div
          class="organic-outfit-item shoes-layer"
          *ngIf="getLayer('shoes') && getCurrentItem(getLayer('shoes')!) as shoesItem"
          cdkDrag
          cdkDragBoundary=".organic-mannequin"
          (cdkDragStarted)="handleDragStarted()"
          (cdkDragEnded)="handleDragEnded()"
          (cdkDragDropped)="handleDragDropped($event)"
          role="img"
          [attr.aria-label]="'Shoes: ' + (shoesItem.originalFileName || 'Unnamed')">
          <img
            [src]="shoesItem.thumbnailUrl || shoesItem.imageUrl"
            [alt]="'Shoes: ' + (shoesItem.originalFileName || 'Unnamed shoes')"
            class="outfit-item-image"
            loading="lazy">
          <div class="organic-drag-handle" aria-hidden="true">
            <mat-icon>drag_indicator</mat-icon>
          </div>
        </div>
        
        <!-- Lil Guy Character - Positioned AFTER all clothing items -->
        <div *ngIf="lilGuyState" class="lil-guy-character">
          <!-- Lil Guy Head -->
          <div class="lil-guy-head" 
               [style.left.%]="headPosition.x"
               [style.top.%]="headPosition.y">
            <img [src]="lilGuyState.currentVariation.headImage" 
                 alt="Lil Guy Head"
                 class="lil-guy-image head-image"
                 [class.alive]="lilGuyState.isAlive"
                 [class.dead]="!lilGuyState.isAlive">
          </div>
          
          <!-- Lil Guy Left Hand -->
          <div class="lil-guy-hand left-hand"
               [style.left.%]="leftHandPosition.x"
               [style.top.%]="leftHandPosition.y">
            <img [src]="lilGuyState.currentVariation.leftHandImage" 
                 alt="Lil Guy Left Hand"
                 class="lil-guy-image hand-image">
          </div>
          
          <!-- Lil Guy Right Hand -->
          <div class="lil-guy-hand right-hand"
               [style.left.%]="rightHandPosition.x"
               [style.top.%]="rightHandPosition.y">
            <img [src]="lilGuyState.currentVariation.rightHandImage" 
                 alt="Lil Guy Right Hand"
                 class="lil-guy-image hand-image">
          </div>
        </div>
      </main>

      <!-- Floating Right Actions -->
      <aside class="floating-right-actions" aria-label="Save outfit">
        <button
          class="organic-action-btn save-btn"
          (click)="handleSaveOutfit()"
          aria-label="Save current outfit"
          type="button">
          <mat-icon aria-hidden="true">favorite</mat-icon>
        </button>
      </aside>

    </div>

    <!-- Bottom Navigation -->
    <nav *ngIf="!isLoading" class="organic-bottom-nav" aria-label="Clothing category navigation">
      
      <!-- HEADWEAR -->
      <div class="category-group" *ngIf="getLayer('hat') as hatLayer">
        <span class="category-title">HEADWEAR</span>
        <div class="category-card" role="group" aria-label="Headwear selector">
          <button
            class="organic-nav-arrow left-arrow"
            (click)="handlePreviousItem(getLayerIndex(hatLayer.category))"
            [disabled]="!hasItems(hatLayer)"
            aria-label="Previous headwear item"
            type="button">
            <mat-icon aria-hidden="true">keyboard_arrow_left</mat-icon>
          </button>
          <div class="organic-category-info">
            <iconify-icon icon="ph:beanie" class="category-icon" aria-hidden="true"></iconify-icon>
            <span class="item-counter" *ngIf="hasItems(hatLayer)" aria-live="polite">
              {{ getLayerInfo(getLayerIndex(hatLayer.category)) }}
            </span>
          </div>
          <button
            class="organic-nav-arrow right-arrow"
            (click)="handleNextItem(getLayerIndex(hatLayer.category))"
            [disabled]="!hasItems(hatLayer)"
            aria-label="Next headwear item"
            type="button">
            <mat-icon aria-hidden="true">keyboard_arrow_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- TOP -->
      <div class="category-group" *ngIf="getLayer('top') as topLayer">
        <div class="category-title">TOP</div>
        <div class="category-card">
          <button class="organic-nav-arrow left-arrow"
                  (click)="handlePreviousItem(getLayerIndex(topLayer.category))"
                  [disabled]="!hasItems(topLayer)">
            <mat-icon>keyboard_arrow_left</mat-icon>
          </button>
          <div class="organic-category-info">
            <iconify-icon icon="tabler:shirt" class="category-icon"></iconify-icon>
            <span class="item-counter" *ngIf="hasItems(topLayer)">{{ getLayerInfo(getLayerIndex(topLayer.category)) }}</span>
          </div>
          <button class="organic-nav-arrow right-arrow"
                  (click)="handleNextItem(getLayerIndex(topLayer.category))"
                  [disabled]="!hasItems(topLayer)">
            <mat-icon>keyboard_arrow_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- ACCESSORY (jacket layer used) -->
      <div class="category-group" *ngIf="getLayer('jacket') as jacketLayer">
        <div class="category-title">ACCESSORY</div>
        <div class="category-card">
          <button class="organic-nav-arrow left-arrow"
                  (click)="handlePreviousItem(getLayerIndex(jacketLayer.category))"
                  [disabled]="!hasItems(jacketLayer)">
            <mat-icon>keyboard_arrow_left</mat-icon>
          </button>
          <div class="organic-category-info">
            <iconify-icon icon="tabler:jacket" class="category-icon"></iconify-icon>
            <span class="item-counter" *ngIf="hasItems(jacketLayer)">{{ getLayerInfo(getLayerIndex(jacketLayer.category)) }}</span>
          </div>
          <button class="organic-nav-arrow right-arrow"
                  (click)="handleNextItem(getLayerIndex(jacketLayer.category))"
                  [disabled]="!hasItems(jacketLayer)">
            <mat-icon>keyboard_arrow_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- BOTTOM -->
      <div class="category-group" *ngIf="getLayer('jeans') as jeansLayer">
        <div class="category-title">BOTTOM</div>
        <div class="category-card">
          <button class="organic-nav-arrow left-arrow"
                  (click)="handlePreviousItem(getLayerIndex(jeansLayer.category))"
                  [disabled]="!hasItems(jeansLayer)">
            <mat-icon>keyboard_arrow_left</mat-icon>
          </button>
          <div class="organic-category-info">
            <iconify-icon icon="ph:pants" class="category-icon"></iconify-icon>
            <span class="item-counter" *ngIf="hasItems(jeansLayer)">{{ getLayerInfo(getLayerIndex(jeansLayer.category)) }}</span>
          </div>
          <button class="organic-nav-arrow right-arrow"
                  (click)="handleNextItem(getLayerIndex(jeansLayer.category))"
                  [disabled]="!hasItems(jeansLayer)">
            <mat-icon>keyboard_arrow_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- SHOES -->
      <div class="category-group" *ngIf="getLayer('shoes') as shoesLayer">
        <div class="category-title">SHOES</div>
        <div class="category-card">
          <button class="organic-nav-arrow left-arrow"
                  (click)="handlePreviousItem(getLayerIndex(shoesLayer.category))"
                  [disabled]="!hasItems(shoesLayer)">
            <mat-icon>keyboard_arrow_left</mat-icon>
          </button>
          <div class="organic-category-info">
            <iconify-icon icon="tabler:shoe" class="category-icon"></iconify-icon>
            <span class="item-counter" *ngIf="hasItems(shoesLayer)">{{ getLayerInfo(getLayerIndex(shoesLayer.category)) }}</span>
          </div>
          <button class="organic-nav-arrow right-arrow"
                  (click)="handleNextItem(getLayerIndex(shoesLayer.category))"
                  [disabled]="!hasItems(shoesLayer)">
            <mat-icon>keyboard_arrow_right</mat-icon>
          </button>
        </div>
      </div>

    </nav>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !hasAnyItems()" class="organic-empty-state">
      <div class="empty-content">
        <mat-icon class="empty-icon">checkroom</mat-icon>
        <h3>Your closet is empty</h3>
        <p>Start building your virtual closet by uploading photos of your clothes!</p>
      </div>
    </div>
  </div>
</div> 